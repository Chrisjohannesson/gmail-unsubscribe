{% extends "base.html" %}

{% block title %}Unsubscribe Manager - Gmail Client{% endblock %}

{% block content %}
<div x-data="unsubscribeManager()" x-init="init()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Unsubscribe Manager</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400">
            Select senders to unsubscribe from. One-click senders are instant!
        </p>
    </div>

    <!-- Progress Panel -->
    <div x-show="status.running || status.results.length > 0" x-cloak class="mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="flex items-center justify-between mb-2">
            <span class="font-medium text-gray-900 dark:text-white">
                <span x-show="status.running">Processing...</span>
                <span x-show="!status.running && status.results.length > 0">Complete!</span>
            </span>
            <span class="text-sm text-gray-500 dark:text-gray-400" x-text="status.progress + '/' + status.total"></span>
        </div>

        <!-- Progress bar -->
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-4">
            <div class="bg-indigo-600 h-2 rounded-full transition-all duration-300"
                 :style="'width: ' + (status.total > 0 ? (status.progress / status.total * 100) : 0) + '%'"></div>
        </div>

        <!-- Results -->
        <div x-show="status.results.length > 0" class="space-y-2 max-h-60 overflow-y-auto">
            <template x-for="result in status.results" :key="result.sender">
                <div class="flex items-center gap-2 text-sm py-1 border-b border-gray-100 dark:border-gray-700">
                    <span x-show="result.success" class="text-green-500">&#10003;</span>
                    <span x-show="!result.success" class="text-red-500">&#10007;</span>
                    <span class="font-medium text-gray-900 dark:text-white" x-text="result.sender"></span>
                    <span class="text-xs px-2 py-0.5 rounded"
                          :class="result.method === 'one-click' ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300' : 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300'"
                          x-text="result.method"></span>
                    <span class="text-gray-500 dark:text-gray-400 text-xs" x-text="result.message"></span>
                </div>
            </template>
        </div>

        <!-- Summary -->
        <div x-show="!status.running && status.results.length > 0" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex gap-4 text-sm mb-2">
                <span class="text-green-600 dark:text-green-400">
                    &#10003; <span x-text="status.results.filter(r => r.success).length"></span> succeeded
                </span>
                <span class="text-red-600 dark:text-red-400">
                    &#10007; <span x-text="status.results.filter(r => !r.success).length"></span> failed
                </span>
            </div>
            <div class="flex gap-4 items-center flex-wrap">
                <label class="inline-flex items-center gap-2 text-sm cursor-pointer">
                    <input type="checkbox" x-model="showOnlyFailed"
                           class="rounded border-gray-300 dark:border-gray-600 text-red-600 focus:ring-red-500">
                    <span class="text-gray-700 dark:text-gray-300">Show only failed</span>
                </label>
                <button @click="openFailedInBrowser()"
                        x-show="status.results.filter(r => !r.success).length > 0"
                        class="px-3 py-1 text-sm bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded hover:bg-orange-200 dark:hover:bg-orange-900/50">
                    Open Failed in Browser
                </button>
                <button @click="status.results = []; status.progress = 0; status.total = 0; showOnlyFailed = false"
                        class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline">
                    Clear results
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Actions -->
    <form action="/unsubscribe" method="post" x-show="selectedSenders.length > 0" x-cloak
          class="mb-4 p-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg flex items-center gap-4">
        <span class="text-sm text-indigo-700 dark:text-indigo-300" x-text="selectedSenders.length + ' senders selected'"></span>
        <template x-for="email in selectedSenders">
            <input type="hidden" name="sender_emails" :value="email">
        </template>
        <button type="submit" :disabled="status.running"
                class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
            Unsubscribe from Selected
        </button>
        <span class="text-xs text-indigo-600 dark:text-indigo-400" x-text="oneClickCount + ' instant, ' + browserCount + ' via browser'"></span>
    </form>

    <!-- Senders List -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
        {% if senders %}
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="w-10 px-4 py-3">
                        <input type="checkbox" @change="toggleAll($event.target.checked)"
                               class="rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                    </th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Sender</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Method</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Emails</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Action</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for sender in senders %}
                <tr x-show="shouldShowRow('{{ sender.sender }}')" class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-4 py-4">
                        {% if sender.unsubscribe_url %}
                        <input type="checkbox" value="{{ sender.sender_email }}"
                               data-one-click="{{ sender.unsubscribe_post or 0 }}"
                               @change="toggleSender('{{ sender.sender_email }}', {{ sender.unsubscribe_post or 0 }}, $event.target.checked)"
                               :checked="selectedSenders.includes('{{ sender.sender_email }}')"
                               class="rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        {% else %}
                        <span class="text-gray-300 dark:text-gray-600">-</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ sender.sender }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">{{ sender.sender_email }}</div>
                    </td>
                    <td class="px-4 py-4">
                        {% if sender.unsubscribe_post %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                            One-Click
                        </span>
                        {% elif sender.unsubscribe_url %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                            Browser
                        </span>
                        {% else %}
                        <span class="text-xs text-gray-400 dark:text-gray-500">None</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4">
                        <span class="text-sm text-gray-900 dark:text-white">{{ sender.email_count }}</span>
                    </td>
                    <td class="px-4 py-4">
                        {% if sender.unsubscribe_url %}
                        <a href="{{ sender.unsubscribe_url }}" target="_blank" rel="noopener"
                           class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline">
                            Open Link
                        </a>
                        {% else %}
                        <span class="text-sm text-gray-400 dark:text-gray-500">-</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4">
                        <template x-if="getResult('{{ sender.sender }}')">
                            <div class="flex items-center gap-2">
                                <template x-if="getResult('{{ sender.sender }}').success">
                                    <span class="inline-flex items-center gap-1 text-green-600 dark:text-green-400">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                        <span class="text-xs">Done</span>
                                    </span>
                                </template>
                                <template x-if="!getResult('{{ sender.sender }}').success">
                                    <div class="group relative">
                                        <span class="inline-flex items-center gap-1 text-red-600 dark:text-red-400 cursor-help">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                            </svg>
                                            <span class="text-xs">Failed</span>
                                        </span>
                                        <div class="absolute bottom-full left-0 mb-2 hidden group-hover:block z-10">
                                            <div class="bg-gray-900 text-white text-xs rounded py-1 px-2 whitespace-nowrap">
                                                <span x-text="getResult('{{ sender.sender }}').message"></span>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="!getResult('{{ sender.sender }}')">
                            <span class="text-xs text-gray-400 dark:text-gray-500">-</span>
                        </template>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% else %}
        <div class="p-8 text-center">
            <p class="text-gray-500 dark:text-gray-400 mb-4">No promotional emails found</p>
            <button @click="syncEmails()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                Sync Emails
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Stats -->
    {% if senders %}
    <div class="mt-4 flex gap-6 text-sm text-gray-500 dark:text-gray-400">
        <span>{{ senders|length }} senders</span>
        <span class="text-green-600 dark:text-green-400">{{ senders|selectattr('unsubscribe_post')|list|length }} one-click</span>
        <span class="text-blue-600 dark:text-blue-400">{{ senders|selectattr('unsubscribe_url')|rejectattr('unsubscribe_post')|list|length }} browser</span>
        <span>{{ senders|rejectattr('unsubscribe_url')|list|length }} no link</span>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function unsubscribeManager() {
    return {
        selectedSenders: [],
        oneClickCount: 0,
        browserCount: 0,
        showOnlyFailed: false,
        status: {
            running: {{ unsub_status.running|tojson }},
            progress: {{ unsub_status.progress }},
            total: {{ unsub_status.total }},
            results: {{ unsub_status.results|tojson }}
        },
        pollInterval: null,

        init() {
            // Start polling if processing
            if (this.status.running || new URLSearchParams(window.location.search).has('processing')) {
                this.startPolling();
            }
        },

        toggleSender(email, isOneClick, checked) {
            if (checked) {
                this.selectedSenders.push(email);
                if (isOneClick) this.oneClickCount++;
                else this.browserCount++;
            } else {
                this.selectedSenders = this.selectedSenders.filter(e => e !== email);
                if (isOneClick) this.oneClickCount--;
                else this.browserCount--;
            }
        },

        toggleAll(checked) {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
            this.selectedSenders = [];
            this.oneClickCount = 0;
            this.browserCount = 0;

            if (checked) {
                checkboxes.forEach(cb => {
                    if (cb.value) {
                        cb.checked = true;
                        this.selectedSenders.push(cb.value);
                        if (cb.dataset.oneClick === '1') this.oneClickCount++;
                        else this.browserCount++;
                    }
                });
            } else {
                checkboxes.forEach(cb => cb.checked = false);
            }
        },

        getResult(senderName) {
            // Look up result by sender name
            return this.status.results.find(r => r.sender === senderName) || null;
        },

        shouldShowRow(senderName) {
            // If filter is off, show all rows
            if (!this.showOnlyFailed) return true;
            // If filter is on, only show rows that have a failed result
            const result = this.getResult(senderName);
            return result && !result.success;
        },

        async openFailedInBrowser() {
            // Fetch failed URLs from API
            try {
                const response = await fetch('/api/failed-urls');
                const data = await response.json();

                if (data.urls.length === 0) {
                    alert('No failed URLs to open');
                    return;
                }

                // Warn if opening many tabs
                if (data.urls.length > 10) {
                    if (!confirm(`This will open ${data.urls.length} tabs. Continue?`)) {
                        return;
                    }
                }

                // Open each URL in a new tab (browsers may block if too many)
                const batchSize = 5;
                for (let i = 0; i < data.urls.length; i += batchSize) {
                    const batch = data.urls.slice(i, i + batchSize);
                    batch.forEach(item => {
                        window.open(item.url, '_blank');
                    });
                    // Small delay between batches to avoid popup blocker
                    if (i + batchSize < data.urls.length) {
                        await new Promise(r => setTimeout(r, 500));
                    }
                }
            } catch (e) {
                console.error('Error fetching failed URLs:', e);
                alert('Failed to get URLs');
            }
        },

        startPolling() {
            this.status.running = true;
            this.pollInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/unsub-status');
                    const data = await response.json();
                    this.status = data;

                    if (!data.running) {
                        clearInterval(this.pollInterval);
                        // Remove processing param from URL
                        const url = new URL(window.location);
                        url.searchParams.delete('processing');
                        window.history.replaceState({}, '', url);
                    }
                } catch (e) {
                    console.error('Polling error:', e);
                }
            }, 1000);
        }
    }
}
</script>
{% endblock %}
